<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor - Pure Code Mode</title>
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-theme">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .editor-container {
            max-width: 900px;
            margin: 40px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }

        .toolbar button {
            padding: 6px 16px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            background: white;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toolbar button:hover {
            background: #f0f0f0;
        }

        .toolbar button.primary {
            background: #4285f4;
            color: white;
            border-color: #4285f4;
        }

        .toolbar button.primary:hover {
            background: #3367d6;
        }

        .toolbar select {
            padding: 6px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            background: white;
            font-size: 13px;
            min-width: 180px;
            cursor: pointer;
        }

        .toolbar .spacer {
            flex: 1;
        }

        .toolbar .language-label {
            font-size: 12px;
            color: #666;
        }

        /* Editor wrapper */
        .editor-wrapper {
            display: flex;
            min-height: 500px;
            font-family: 'Fira Code', 'JetBrains Mono', 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Line numbers gutter */
        .line-numbers {
            flex-shrink: 0;
            padding: 12px 0;
            background: #f8f8f8;
            border-right: 1px solid #e8e8e8;
            text-align: right;
            user-select: none;
            color: #999;
            min-width: 50px;
        }

        .line-number {
            padding: 0 12px 0 8px;
            height: 21px;
            line-height: 21px;
        }

        .line-number.active {
            color: #333;
            background: #e8f4fd;
        }

        /* Code area */
        .code-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        /* Highlighted code display (background layer) */
        .code-highlight {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 12px 16px;
            overflow: auto;
            white-space: pre;
            pointer-events: none;
            color: transparent;
        }

        .code-highlight code {
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
        }

        /* Textarea for editing (foreground layer) */
        .code-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 12px 16px;
            border: none;
            outline: none;
            resize: none;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            background: transparent;
            color: transparent;
            caret-color: #333;
            white-space: pre;
            overflow: auto;
        }

        /* Visible syntax-highlighted code */
        .code-display {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 12px 16px;
            overflow: auto;
            white-space: pre;
            pointer-events: none;
        }

        .code-display pre {
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            background: transparent !important;
            padding: 0 !important;
        }

        .code-display code {
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            background: transparent !important;
            padding: 0 !important;
        }

        /* Line highlight */
        .line-highlight {
            position: absolute;
            left: 0;
            right: 0;
            height: 21px;
            background: #e8f4fd;
            pointer-events: none;
            z-index: -1;
        }

        /* Sync scrolling */
        .code-area.synced .code-input,
        .code-area.synced .code-display {
            overflow: hidden;
        }

        /* Status bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 6px 12px;
            background: #fafafa;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #666;
        }

        .status-bar .position {
            font-family: monospace;
        }

        /* Output section */
        .output-section {
            margin-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .output-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            font-weight: 500;
        }

        .output-content {
            padding: 12px 16px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            min-height: 100px;
            max-height: 200px;
            overflow: auto;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .output-content.error {
            color: #f44336;
        }

        .output-content.success {
            color: #4caf50;
        }

        /* Dark theme */
        body.dark {
            background: #1e1e1e;
        }

        body.dark .editor-container {
            background: #282c34;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        body.dark .toolbar {
            background: #21252b;
            border-color: #181a1f;
        }

        body.dark .toolbar button {
            background: #2c313a;
            border-color: #181a1f;
            color: #abb2bf;
        }

        body.dark .toolbar button:hover {
            background: #3e4451;
        }

        body.dark .toolbar select {
            background: #2c313a;
            border-color: #181a1f;
            color: #abb2bf;
        }

        body.dark .line-numbers {
            background: #21252b;
            border-color: #181a1f;
            color: #636d83;
        }

        body.dark .line-number.active {
            color: #abb2bf;
            background: rgba(255,255,255,0.05);
        }

        body.dark .code-input {
            caret-color: #abb2bf;
        }

        body.dark .line-highlight {
            background: rgba(255,255,255,0.05);
        }

        body.dark .status-bar {
            background: #21252b;
            border-color: #181a1f;
            color: #636d83;
        }

        body.dark .output-header {
            background: #21252b;
            border-color: #181a1f;
            color: #abb2bf;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- Toolbar -->
        <div class="toolbar">
            <button class="primary" id="run-btn">Run</button>
            <button id="share-btn">Share</button>
            <select id="example-select">
                <option value="">Select example...</option>
                <option value="hello">Hello World</option>
                <option value="fibonacci">Fibonacci</option>
                <option value="fetch">Fetch API</option>
                <option value="class">ES6 Class</option>
                <option value="async">Async/Await</option>
            </select>
            <span class="spacer"></span>
            <span class="language-label">Language:</span>
            <select id="language-select">
                <option value="javascript">JavaScript</option>
                <option value="typescript">TypeScript</option>
                <option value="python">Python</option>
                <option value="html">HTML</option>
                <option value="css">CSS</option>
                <option value="json">JSON</option>
                <option value="sql">SQL</option>
                <option value="bash">Bash</option>
            </select>
            <button id="theme-btn" title="Toggle theme">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"/>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
            </button>
        </div>

        <!-- Editor -->
        <div class="editor-wrapper">
            <!-- Line numbers -->
            <div class="line-numbers" id="line-numbers"></div>

            <!-- Code area -->
            <div class="code-area" id="code-area">
                <div class="line-highlight" id="line-highlight"></div>
                <div class="code-display" id="code-display"><pre><code class="language-javascript"></code></pre></div>
                <textarea class="code-input" id="code-input" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
            </div>
        </div>

        <!-- Status bar -->
        <div class="status-bar">
            <span class="position" id="cursor-position">Ln 1, Col 1</span>
            <span id="file-info">JavaScript | UTF-8</span>
        </div>

        <!-- Output section -->
        <div class="output-section">
            <div class="output-header">
                <span>Console Output</span>
                <button id="clear-output-btn" style="padding: 2px 8px; font-size: 11px;">Clear</button>
            </div>
            <div class="output-content" id="output">// Output will appear here when you run the code</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // ============================================
        // PURE CODE EDITOR
        // ============================================

        const codeInput = document.getElementById('code-input');
        const codeDisplay = document.getElementById('code-display');
        const lineNumbers = document.getElementById('line-numbers');
        const lineHighlight = document.getElementById('line-highlight');
        const cursorPosition = document.getElementById('cursor-position');
        const output = document.getElementById('output');
        const languageSelect = document.getElementById('language-select');
        const exampleSelect = document.getElementById('example-select');
        const fileInfo = document.getElementById('file-info');

        let currentLanguage = 'javascript';

        // Example code snippets
        const examples = {
            hello: `// Hello World Example
console.log("Hello, World!");
console.log("Welcome to the code editor!");`,

            fibonacci: `// Fibonacci Sequence
function fibonacci(n) {
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
}

// Calculate first 10 Fibonacci numbers
const results = [];
for (let i = 0; i < 10; i++) {
    results.push(fibonacci(i));
}
console.log("Fibonacci sequence:", results);`,

            fetch: `// Fetch API Example
async function fetchData() {
    try {
        const response = await fetch('https://jsonplaceholder.typicode.com/posts/1');
        const data = await response.json();
        console.log("Title:", data.title);
        console.log("Body:", data.body);
    } catch (error) {
        console.error("Error:", error.message);
    }
}

fetchData();`,

            class: `// ES6 Class Example
class Animal {
    constructor(name) {
        this.name = name;
    }

    speak() {
        console.log(\`\${this.name} makes a sound.\`);
    }
}

class Dog extends Animal {
    constructor(name, breed) {
        super(name);
        this.breed = breed;
    }

    speak() {
        console.log(\`\${this.name} barks!\`);
    }
}

const dog = new Dog("Max", "Golden Retriever");
dog.speak();
console.log(\`Breed: \${dog.breed}\`);`,

            async: `// Async/Await Example
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

async function processItems() {
    const items = ['Apple', 'Banana', 'Cherry'];

    console.log("Processing items...");

    for (const item of items) {
        await delay(500);
        console.log(\`Processed: \${item}\`);
    }

    console.log("All items processed!");
}

processItems();`
        };

        // Default code
        const defaultCode = `import {basicSetup, EditorView} from "codemirror"
import {javascript} from "@codemirror/lang-javascript"

new EditorView({
    doc: "console.log('hello')\\n",
    extensions: [basicSetup, javascript()],
    parent: document.body
})`;

        // Initialize
        codeInput.value = defaultCode;
        updateEditor();

        // ============================================
        // LINE NUMBERS
        // ============================================

        function updateLineNumbers() {
            const lines = codeInput.value.split('\n');
            const lineCount = lines.length;

            // Get current line
            const cursorPos = codeInput.selectionStart;
            const textBeforeCursor = codeInput.value.substring(0, cursorPos);
            const currentLine = textBeforeCursor.split('\n').length;

            // Build line numbers HTML
            let html = '';
            for (let i = 1; i <= lineCount; i++) {
                const isActive = i === currentLine;
                html += `<div class="line-number${isActive ? ' active' : ''}">${i}</div>`;
            }
            lineNumbers.innerHTML = html;

            // Update line highlight position
            const lineHeight = 21;
            const topOffset = 12; // padding-top
            lineHighlight.style.top = `${topOffset + (currentLine - 1) * lineHeight}px`;
        }

        // ============================================
        // SYNTAX HIGHLIGHTING
        // ============================================

        function updateHighlighting() {
            const code = codeInput.value;
            const codeElement = codeDisplay.querySelector('code');

            // Update language class
            codeElement.className = `language-${currentLanguage}`;

            // Escape HTML and set content
            codeElement.textContent = code;

            // Apply highlighting
            if (hljs.getLanguage(currentLanguage)) {
                hljs.highlightElement(codeElement);
            }
        }

        // ============================================
        // CURSOR POSITION
        // ============================================

        function updateCursorPosition() {
            const cursorPos = codeInput.selectionStart;
            const textBeforeCursor = codeInput.value.substring(0, cursorPos);
            const lines = textBeforeCursor.split('\n');
            const line = lines.length;
            const col = lines[lines.length - 1].length + 1;

            cursorPosition.textContent = `Ln ${line}, Col ${col}`;
        }

        // ============================================
        // SCROLL SYNC
        // ============================================

        function syncScroll() {
            codeDisplay.scrollTop = codeInput.scrollTop;
            codeDisplay.scrollLeft = codeInput.scrollLeft;

            // Also sync line numbers vertically
            lineNumbers.scrollTop = codeInput.scrollTop;
        }

        // ============================================
        // UPDATE EDITOR
        // ============================================

        function updateEditor() {
            updateLineNumbers();
            updateHighlighting();
            updateCursorPosition();
        }

        // ============================================
        // TAB HANDLING
        // ============================================

        function handleTab(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = codeInput.selectionStart;
                const end = codeInput.selectionEnd;

                // Insert 2 spaces
                const spaces = '  ';
                codeInput.value = codeInput.value.substring(0, start) + spaces + codeInput.value.substring(end);
                codeInput.selectionStart = codeInput.selectionEnd = start + spaces.length;

                updateEditor();
            }
        }

        // ============================================
        // AUTO-INDENT ON ENTER
        // ============================================

        function handleEnter(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const start = codeInput.selectionStart;
                const textBefore = codeInput.value.substring(0, start);
                const textAfter = codeInput.value.substring(start);

                // Get current line's indentation
                const currentLine = textBefore.split('\n').pop();
                const indent = currentLine.match(/^\s*/)[0];

                // Check if previous char is { or : or [ or (
                const lastChar = textBefore.trim().slice(-1);
                const extraIndent = ['{', ':', '[', '('].includes(lastChar) ? '  ' : '';

                // Insert newline with indent
                const insertion = '\n' + indent + extraIndent;
                codeInput.value = textBefore + insertion + textAfter;
                codeInput.selectionStart = codeInput.selectionEnd = start + insertion.length;

                updateEditor();
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        codeInput.addEventListener('input', updateEditor);
        codeInput.addEventListener('keydown', handleTab);
        codeInput.addEventListener('keydown', handleEnter);
        codeInput.addEventListener('click', () => {
            updateLineNumbers();
            updateCursorPosition();
        });
        codeInput.addEventListener('keyup', () => {
            updateLineNumbers();
            updateCursorPosition();
        });
        codeInput.addEventListener('scroll', syncScroll);

        // Language change
        languageSelect.addEventListener('change', function() {
            currentLanguage = this.value;
            fileInfo.textContent = `${this.options[this.selectedIndex].text} | UTF-8`;
            updateHighlighting();
        });

        // Example selection
        exampleSelect.addEventListener('change', function() {
            if (this.value && examples[this.value]) {
                codeInput.value = examples[this.value];
                updateEditor();
            }
            this.value = ''; // Reset selector
        });

        // Run button
        document.getElementById('run-btn').addEventListener('click', function() {
            runCode();
        });

        // Keyboard shortcut: Ctrl+Enter to run
        codeInput.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                runCode();
            }
        });

        // Run code
        function runCode() {
            output.className = 'output-content';
            output.textContent = '';

            // Capture console.log
            const logs = [];
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;

            console.log = (...args) => {
                logs.push(args.map(arg =>
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' '));
                originalLog.apply(console, args);
            };

            console.error = (...args) => {
                logs.push('Error: ' + args.join(' '));
                originalError.apply(console, args);
            };

            console.warn = (...args) => {
                logs.push('Warning: ' + args.join(' '));
                originalWarn.apply(console, args);
            };

            try {
                // Only run JavaScript
                if (currentLanguage === 'javascript') {
                    const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
                    const fn = new AsyncFunction(codeInput.value);
                    fn().then(() => {
                        setTimeout(() => {
                            if (logs.length > 0) {
                                output.textContent = logs.join('\n');
                                output.classList.add('success');
                            } else {
                                output.textContent = '// Code executed successfully (no output)';
                            }
                        }, 100);
                    }).catch(err => {
                        output.textContent = `Error: ${err.message}`;
                        output.classList.add('error');
                    });
                } else {
                    output.textContent = `// Cannot run ${currentLanguage} code in browser.\n// Only JavaScript is supported.`;
                }
            } catch (err) {
                output.textContent = `Error: ${err.message}`;
                output.classList.add('error');
            }

            // Restore console
            setTimeout(() => {
                console.log = originalLog;
                console.error = originalError;
                console.warn = originalWarn;
            }, 1000);
        }

        // Clear output
        document.getElementById('clear-output-btn').addEventListener('click', function() {
            output.className = 'output-content';
            output.textContent = '// Output will appear here when you run the code';
        });

        // Share button
        document.getElementById('share-btn').addEventListener('click', function() {
            // Encode code to URL
            const encoded = encodeURIComponent(codeInput.value);
            const url = `${window.location.href.split('?')[0]}?code=${encoded}&lang=${currentLanguage}`;

            navigator.clipboard.writeText(url).then(() => {
                this.textContent = 'Copied!';
                setTimeout(() => {
                    this.textContent = 'Share';
                }, 2000);
            });
        });

        // Theme toggle
        document.getElementById('theme-btn').addEventListener('click', function() {
            document.body.classList.toggle('dark');

            // Switch highlight.js theme
            const isDark = document.body.classList.contains('dark');
            const hljsTheme = document.getElementById('hljs-theme');
            hljsTheme.href = isDark
                ? 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css'
                : 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css';

            // Re-apply highlighting
            setTimeout(updateHighlighting, 50);
        });

        // Load from URL params
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('code')) {
            codeInput.value = decodeURIComponent(urlParams.get('code'));
            updateEditor();
        }
        if (urlParams.has('lang')) {
            const lang = urlParams.get('lang');
            if (languageSelect.querySelector(`option[value="${lang}"]`)) {
                languageSelect.value = lang;
                currentLanguage = lang;
                fileInfo.textContent = `${languageSelect.options[languageSelect.selectedIndex].text} | UTF-8`;
                updateHighlighting();
            }
        }

        console.log('Pure Code Editor loaded! Press Ctrl+Enter to run code.');
    </script>
</body>
</html>
